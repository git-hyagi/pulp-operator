name: "Install pre-reqs"
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.8
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
    - name: Setup Go environment
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: false
    - name: Install httpie
      run: |
        echo ::group::HTTPIE
        sudo apt-get update -yq
        sudo -E apt-get -yq --no-install-suggests --no-install-recommends install httpie
        echo ::endgroup::
        echo "HTTPIE_CONFIG_DIR=$GITHUB_WORKSPACE/.ci/assets/httpie/" >> $GITHUB_ENV
        echo "CI_TEST=true" >> $GITHUB_ENV
        echo "TEST=pulp" >> $GITHUB_ENV
      shell: bash
    - name: Updating registries configuration
      run: |
        if [ -f "/etc/docker/daemon.json" ] || sudo systemctl is-active --quiet docker
        then
          echo "INFO:
          Updating docker configuration
          "

          echo "$(cat /etc/docker/daemon.json | jq -s '.[0] + {
          "insecure-registries" : ["ingress.local","nodeport.local:30000"]
          }')" | sudo tee /etc/docker/daemon.json
          sudo service docker restart || true
        fi

        if [ -f "/etc/containers/registries.conf" ]
        then
          echo "INFO:
          Updating registries configuration
          "
          echo "[registries.insecure]
          registries = ['ingress.local','nodeport.local:30000']
          " | sudo tee -a /etc/containers/registries.conf
        fi
      shell: bash
    - name: Start minikube
      run: |
        minikube start --memory=max --cpus=max --vm-driver=docker --extra-config=apiserver.service-node-port-range=80-32000
        minikube addons enable metrics-server
      # now you can run kubectl to see the pods in the cluster
    - name: Try the cluster !
      run: kubectl get pods -A
    - name: Setup a minikube docker env
      run: minikube -p minikube docker-env | grep "export" | sed 's/export //' | sed 's/"//g' >> $GITHUB_ENV
